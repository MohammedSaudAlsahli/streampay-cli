# Stream Pay CLI - Project Structure

## Overview
Complete CLI tool for interacting with Stream App API, designed for both developers and AI agents.

## Project Structure

```
streampay-cli/
├── package.json
├── tsconfig.json
├── setup.sh
├── .env.example
├── .gitignore
├── README.md
├── CHANGELOG.md
├── API-REFERENCE.md
├── AI-AGENT-GUIDE.md
├── STRUCTURE.md
├── AGENTS.md
├── src/
│   ├── index.ts              # Main CLI entry point — registers all command groups
│   ├── client.ts             # StreamAppClient — all HTTP methods + Axios interceptor
│   ├── config.ts             # ConfigManager — reads env vars + ~/.streampay/config.json
│   ├── utils.ts              # OutputFormatter, parseJson(), parseFilters()
│   └── commands/
│       ├── config.ts         # streampay config (set/get/clear/path)
│       ├── consumers.ts      # streampay consumers (create/get/list/update/delete)
│       ├── payments.ts       # streampay payments (get/list/mark-paid/refund/auto-charge)
│       ├── subscriptions.ts  # streampay subscriptions (create/get/list/update/cancel/freeze/unfreeze/freezes)
│       ├── invoices.ts       # streampay invoices (create/get/list/update/send/accept/reject/complete/cancel)
│       ├── products.ts       # streampay products (create/get/list/update/delete)
│       ├── coupons.ts        # streampay coupons (create/get/list/update/delete)
│       ├── checkout.ts       # streampay checkout (create/get/list/activate/deactivate/update-status)
│       └── webhooks.ts       # streampay webhooks (events/verify)
├── examples/
│   ├── consumer-create.json
│   └── subscription-create.json
└── dist/                     # Compiled JavaScript (generated by tsc)
```

## Key Files

### Configuration Files

- **package.json**: Defines project metadata, dependencies, and scripts
- **tsconfig.json**: TypeScript compiler configuration
- **.env.example**: Template for environment variables

### Source Files

- **src/index.ts**: Main entry point that registers all command groups
- **src/client.ts**: HTTP client for Stream App API (all HTTP methods + Axios interceptor)
- **src/config.ts**: Manages configuration from env vars, files, and CLI flags
- **src/utils.ts**: Output formatting (`OutputFormatter`), `parseJson()`, `parseFilters()`

### Command Modules

Each command module follows the same pattern:
- Uses Commander.js for CLI parsing
- Supports JSON/Table/Pretty output formats
- Includes pagination support
- Comprehensive error handling with `process.exit(1)` on failure

### Documentation

- **README.md**: Installation, usage, and examples
- **CHANGELOG.md**: Version history and release notes
- **API-REFERENCE.md**: Full API endpoint reference
- **AI-AGENT-GUIDE.md**: Detailed guide for AI agent integration
- **AGENTS.md**: Coding agent guide for contributors
- **STRUCTURE.md**: This file — project organization

## Technology Stack

- **TypeScript**: Type-safe development
- **Commander.js**: CLI framework
- **Axios**: HTTP client
- **Chalk** (v4): Terminal colors — v4 is CJS-compatible; do not upgrade to v5+
- **Table**: Tabular output
- **Ora**: Loading spinners (installed, currently unused)
- **dotenv**: Environment variable management

## Build Process

1. TypeScript files in `src/` are compiled to JavaScript
2. Output goes to `dist/` directory
3. `dist/index.js` becomes the executable entry point

## Command Pattern

All commands follow this structure:

```typescript
command
  .command('action')
  .description('What it does')
  .argument('<required>', 'Description')
  .option('--optional <value>', 'Description', default)
  .action(async (args, options) => {
    try {
      const config = ConfigManager.getConfig();
      const client = new StreamAppClient({ apiKey: ConfigManager.getApiKey(), ...config });
      const result = await client.someMethod(params);
      OutputFormatter.success('Success message');
      OutputFormatter.output(result, { format: options.format });
    } catch (error) {
      OutputFormatter.error('Failure message', error);
      process.exit(1);
    }
  });
```

## API Client Features

- Automatic branch scoping via `X-Branch` header
- Centralized error handling via Axios response interceptor
- Type-safe request/response
- Support for all Stream App endpoints

## Configuration Priority

1. CLI flags (`--api-key`, `--base-url`, `--branch`)
2. Environment variables (`STREAMPAY_API_KEY`, `STREAMPAY_BASE_URL`, `STREAMPAY_BRANCH`)
3. Config file (`~/.streampay/config.json`)

## Output Formats

### JSON (`--format json`)
- Machine-readable
- Perfect for AI agents and scripting
- Includes full response data

### Table (`--format table`)
- Columnar view
- Good for list operations
- Human-readable

### Pretty (`--format pretty`) - Default
- Colored output
- Nested object visualization
- Best for interactive use

## Extension Points

The CLI can be extended by:

1. **Adding new commands**: Create new files in `src/commands/`, export a `create<Name>Commands()` factory, and register it in `src/index.ts`
2. **Adding new API methods**: Update `src/client.ts`
3. **Custom formatters**: Extend `src/utils.ts`
4. **MCP Server**: Wrap the CLI for direct AI agent access

## Testing Recommendations

- Use `examples/` directory for sample data
- Test with `--format json` for automation
- Use different branches for testing vs production
- Validate JSON before sending to API
- Run `npm run build` after changes to catch TypeScript errors

## AI Agent Integration

The CLI is optimized for AI agents through:

- Consistent command structure
- JSON output format
- Exit codes for success/failure
- Structured error messages
- Full API coverage
- Scriptable operations

## Deployment

### Local Development
```bash
npm install
npm run build
npm link
```

### Global Installation
```bash
npm install -g streampay-cli
```

### Docker (Future)
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY . .
RUN npm install && npm run build
ENTRYPOINT ["node", "dist/index.js"]
```

## Versioning

Follows semantic versioning (SemVer):
- MAJOR: Breaking changes
- MINOR: New features (backwards compatible)
- PATCH: Bug fixes

Current version: 1.1.0

## Support

- Documentation: README.md
- AI Integration: AI-AGENT-GUIDE.md
- Examples: examples/ directory
- Issues: GitHub Issues
